<!DOCTYPE html><html><head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Star Bird: Custom Edition</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <style>
        :root { --main-yellow: #fcd34d; --bg-sky: #0ea5e9; --danger: #ef4444; --accent-blue: #3b82f6; --boost: #a855f7; }
        body { font-family: 'Segoe UI', sans-serif; background: #020617; color: white; text-align: center; margin: 0; padding: 10px; overflow-x: hidden; touch-action: manipulation; }
        
        .turbo-mode { animation: flashBg 0.2s infinite; }
        @keyframes flashBg { 0% { background: #020617; } 50% { background: #1e293b; } 100% { background: #020617; } }

        .withdraw-panel { background: var(--accent-blue); border-radius: 15px; padding: 12px; margin-bottom: 10px; box-shadow: 0 4px 15px rgba(0,0,0,0.5); }
        .progress-container { background: rgba(0,0,0,0.3); height: 8px; border-radius: 10px; margin-top: 8px; overflow: hidden; }
        #progressBar { background: var(--main-yellow); width: 0%; height: 100%; transition: 0.5s; }

        .wallet-card { background: #1e293b; border-radius: 20px; padding: 15px; margin-bottom: 10px; border: 1px solid #334155; display: flex; justify-content: space-around; cursor: pointer; }
        .balance-value { font-size: 22px; color: var(--main-yellow); font-weight: bold; }

        #game-scene { 
            position: relative; width: 100%; height: 240px; 
            background: linear-gradient(180deg, #38bdf8 0%, #0ea5e9 100%); 
            border-radius: 24px; overflow: hidden; margin-bottom: 10px; border: 3px solid #1e293b;
        }

        #bird-container { position: absolute; left: 40px; top: 50%; transform: translateY(-50%); z-index: 15; transition: top 0.25s cubic-bezier(0.175, 0.885, 0.32, 1.275); }
        #bird { font-size: 50px; transform: scaleX(-1); display: inline-block; }
        
        #multiplier-badge { 
            position: absolute; top: -20px; left: 50%; transform: translateX(-50%); 
            background: rgba(0,0,0,0.8); padding: 2px 10px; border-radius: 10px; 
            font-size: 14px; font-weight: 900; color: var(--main-yellow); display: none; 
        }

        .star-prize { position: absolute; right: -50px; font-size: 26px; z-index: 12; transition: right 0.6s linear; pointer-events: none; }
        .crash-symbol { font-size: 38px; animation: shake 0.2s infinite; }
        @keyframes shake { 0% { transform: translate(2px, 2px); } 50% { transform: translate(-2px, -3px); } 100% { transform: translate(2px, 2px); } }

        .controls { display: grid; grid-template-columns: 1fr 1fr; gap: 8px; }
        .btn { padding: 12px 5px; border: none; border-radius: 12px; font-weight: bold; cursor: pointer; color: white; font-size: 11px; }
        .btn:disabled { background: #475569 !important; opacity: 0.7; cursor: not-allowed; }

        .btn-free { background: #8b5cf6; grid-column: span 2; }
        .btn-std { background: #10b981; }
        .btn-super { background: #f59e0b; }
        .btn-boost { background: var(--boost); grid-column: span 2; border: 2px solid white; }
        .btn-energy { background: #ec4899; grid-column: span 2; }
        .btn-ref { background: #3b82f6; grid-column: span 2; }
        
        .btn-take { background: var(--main-yellow); color: #000; grid-column: span 2; display: none; font-size: 22px; font-weight: 900; }

        .history-panel { background: #1e293b; border-radius: 15px; padding: 10px; margin-top: 15px; }
        .history-list { display: flex; flex-direction: column-reverse; gap: 5px; max-height: 100px; overflow-y: auto; font-size: 12px; }
        .hist-win { color: #10b981; }
        .hist-loss { color: #ef4444; }
    </style></head><body>

    <div class="withdraw-panel">
        <div style="display: flex; justify-content: space-around; font-size: 10px;">
            <span>–ü–†–û–ì–†–ï–°–°: <span id="with-val">0</span>%</span>
            <span>–î–†–£–ó–¨–Ø: <span id="ref-val">0</span>/5</span>
        </div>
        <div class="progress-container"><div id="progressBar"></div></div>
    </div>

    <div class="wallet-card" onclick="requestStars(100)">
        <div style="text-align:left"><small>–ë–ê–õ–ê–ù–°</small><div class="balance-value"><span id="balanceDisplay">0</span> ‚≠ê</div></div>
        <div style="text-align:right"><small>–í –ü–û–õ–ï–¢–ï</small><div class="balance-value" style="color:white"><span id="currentWin">0</span> ‚≠ê</div></div>
    </div>

    <div id="game-scene">
        <div id="bird-container">
            <div id="multiplier-badge">x1.00</div>
            <div id="bird">üê¶‚Äç‚¨õ</div>
        </div>
    </div>

    <div class="controls" id="mainControls">
        <button id="freeBtn" class="btn btn-free" onclick="startFlight(0)">–ë–ï–°–ü–õ–ê–¢–ù–´–ô –ü–û–õ–ï–¢</button>
        <button id="energyBtn" class="btn btn-energy" onclick="handleEnergy()">‚ö° –ö–£–ü–ò–¢–¨ –≠–ù–ï–†–ì–ò–Æ (25 ‚≠ê)</button>
        <button id="stdBtn" class="btn btn-std" onclick="handleFlight(50)">–û–ë–´–ß–ù–´–ô (50)</button>
        <button id="superBtn" class="btn btn-super" onclick="handleFlight(150)">–°–£–ü–ï–† (150)</button>
        <button id="boostBtn" class="btn btn-boost" onclick="handleFlight(300)">üî• –ë–£–°–¢–ï–† (300) üî•</button>
        <button id="refBtn" class="btn btn-ref" onclick="inviteFriend()">–ü–†–ò–ì–õ–ê–°–ò–¢–¨ –î–†–£–ó–ï–ô</button>
    </div>
    
    <button id="takeBtn" class="btn btn-take" onclick="takeWin()">–ó–ê–ë–†–ê–¢–¨ ‚≠ê</button>

    <div class="history-panel"><div id="historyList" class="history-list"></div></div>

    <script>
        const tg = window.Telegram.WebApp;
        tg.expand();

        let balance = parseInt(localStorage.getItem('birdBalance')) || 100;
        let friends = parseInt(localStorage.getItem('birdFriends')) || 0;
        let isPlaying = false;
        let flightTotal = 0;
        let flightInterval, multiInterval;
        let startTime, currentCost = 0;

        const COOLDOWN_MS = 8 * 60 * 60 * 1000;

        // --- –ò–ù–¢–ï–ì–†–ê–¶–ò–Ø –° –¢–í–û–ò–ú PYTHON –ë–û–¢–û–ú ---
        async function requestStars(amount) {
            // –¢–≤–æ–π –±–æ—Ç –¥–æ–ª–∂–µ–Ω —É–º–µ—Ç—å –ø—Ä–∏–Ω–∏–º–∞—Ç—å —Ç–∞–∫–∏–µ –∑–∞–ø—Ä–æ—Å—ã –∏ –æ—Ç–¥–∞–≤–∞—Ç—å invoice_link
            try {
                const response = await fetch('/create-invoice', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ 
                        user_id: tg.initDataUnsafe.user?.id, 
                        stars: amount 
                    })
                });
                const data = await response.json();
                if (data.invoice_link) {
                    tg.openInvoice(data.invoice_link, (status) => {
                        if (status === 'paid') {
                            balance += amount;
                            updateUI();
                        }
                    });
                }
            } catch (e) {
                // –ï—Å–ª–∏ API –µ—â–µ –Ω–µ –≥–æ—Ç–æ–≤–æ, –ø—Ä–æ—Å—Ç–æ –ø–æ–ø–æ–ª–Ω—è–µ–º –¥–ª—è —Ç–µ—Å—Ç–∞ (—É–¥–∞–ª–∏ –≤ –ø—Ä–æ–¥–∞–∫—à–µ–Ω–µ)
                if(confirm(`–û–ø–ª–∞—Ç–∏—Ç—å ${amount} –∑–≤–µ–∑–¥ —á–µ—Ä–µ–∑ Telegram Stars?`)) {
                    balance += amount; updateUI();
                }
            }
        }

        function updateUI() {
            document.getElementById('balanceDisplay').innerText = balance;
            document.getElementById('currentWin').innerText = flightTotal;
            document.getElementById('ref-val').innerText = friends;
            document.getElementById('takeBtn').innerText = `–ó–ê–ë–†–ê–¢–¨: ${flightTotal} ‚≠ê`;
            
            let prog = Math.min((balance/1000)*50 + (friends/5)*50, 100);
            document.getElementById('progressBar').style.width = prog + '%';
            document.getElementById('with-val').innerText = Math.floor(prog);
            
            localStorage.setItem('birdBalance', balance);
            localStorage.setItem('birdFriends', friends);
            checkCooldown();
        }

        function checkCooldown() {
            const lastFree = parseInt(localStorage.getItem('lastFreeFlight')) || 0;
            const now = Date.now();
            const btn = document.getElementById('freeBtn');
            
            if (now - lastFree < COOLDOWN_MS) {
                const remain = COOLDOWN_MS - (now - lastFree);
                const h = Math.floor(remain / 3600000);
                const m = Math.floor((remain % 3600000) / 60000);
                const s = Math.floor((remain % 60000) / 1000);
                btn.disabled = true;
                btn.innerText = `–°–õ–ï–î. –ü–û–õ–ï–¢ –ß–ï–†–ï–ó ${h}—á ${m}–º ${s}—Å`;
            } else {
                btn.disabled = false;
                btn.innerText = "–ë–ï–°–ü–õ–ê–¢–ù–´–ô –ü–û–õ–ï–¢";
            }
        }

        setInterval(checkCooldown, 1000);

        function handleEnergy() {
            if (balance >= 25) {
                balance -= 25;
                localStorage.setItem('lastFreeFlight', 0);
                updateUI();
                alert("–≠–Ω–µ—Ä–≥–∏—è –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∞!");
            } else { requestStars(25); }
        }

        function handleFlight(cost) {
            if (balance >= cost) { startFlight(cost); } 
            else { requestStars(cost); }
        }

        // --- –õ–û–ì–ò–ö–ê –ü–û–õ–ï–¢–ê (–ë–ï–ó –ò–ó–ú–ï–ù–ï–ù–ò–ô) ---
        function startFlight(cost) {
            if (isPlaying) return;
            if (cost === 0) localStorage.setItem('lastFreeFlight', Date.now());
            
            isPlaying = true;
            currentCost = cost;
            balance -= cost;
            flightTotal = 0;
            
            document.getElementById('mainControls').style.display = 'none';
            document.getElementById('takeBtn').style.display = 'block';
            document.getElementById('multiplier-badge').style.display = 'block';
            if(cost === 300) document.body.classList.add('turbo-mode');

            startTime = Date.now();
            updateUI();

            multiInterval = setInterval(() => {
                let sec = (Date.now() - startTime) / 1000;
                document.getElementById('multiplier-badge').innerText = 'x' + (1 + sec * 0.25).toFixed(2);
            }, 100);

            flightInterval = setInterval(() => {
                let sec = (Date.now() - startTime) / 1000;
                let crashChance = sec < 2 ? 5 : (15 + sec * 7); 
                spawnObject(Math.random() * 100 < crashChance);
            }, 900);
        }

        function spawnObject(isCrash) {
            const obj = document.createElement('div');
            obj.className = 'star-prize' + (isCrash ? ' crash-symbol' : '');
            obj.innerHTML = isCrash ? "üí•" : "‚≠ê";
            obj.style.top = (Math.random() * 60 + 20) + '%';
            document.getElementById('game-scene').appendChild(obj);
            setTimeout(() => obj.style.right = '75%', 50);
            setTimeout(() => {
                if (!isPlaying) { obj.remove(); return; }
                document.getElementById('bird-container').style.top = obj.style.top;
                setTimeout(() => {
                    if (isCrash) { doCrash(); } 
                    else {
                        let sec = (Date.now()-startTime)/1000;
                        flightTotal += currentCost === 0 ? 5 : Math.floor(currentCost / 8 * (1 + sec * 0.5));
                        updateUI();
                    }
                    obj.remove();
                }, 200);
            }, 600);
        }

        function doCrash() {
            isPlaying = false;
            clearInterval(flightInterval);
            clearInterval(multiInterval);
            document.body.classList.remove('turbo-mode');
            addHistory(currentCost, 0, true);
            alert("–ö–†–ê–®!");
            resetGame();
        }

        function takeWin() {
            balance += flightTotal;
            addHistory(currentCost, flightTotal, false);
            isPlaying = false;
            clearInterval(flightInterval);
            clearInterval(multiInterval);
            document.body.classList.remove('turbo-mode');
            resetGame();
        }

        function resetGame() {
            document.getElementById('mainControls').style.display = 'grid';
            document.getElementById('takeBtn').style.display = 'none';
            document.getElementById('multiplier-badge').style.display = 'none';
            document.querySelectorAll('.star-prize').forEach(s => s.remove());
            updateUI();
        }

        function addHistory(cost, win, isCrash) {
            const item = document.createElement('div');
            item.style.display = 'flex';
            item.style.justifyContent = 'space-between';
            item.innerHTML = `<span>–°—Ç–∞–≤–∫–∞: ${cost}</span><span class="${isCrash?'hist-loss':'hist-win'}">${isCrash?'CRASH':'+'+win+' ‚≠ê'}</span>`;
            document.getElementById('historyList').appendChild(item);
        }

        function inviteFriend() { friends++; updateUI(); }

        updateUI();
    </script>
</body></html>
