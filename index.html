<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Star Bird: –ü–¢–ò–ß–ö–ê V1.02</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <style>
        :root { --main-yellow: #fcd34d; --bg-sky: #0ea5e9; --accent-blue: #3b82f6; --danger: #ef4444; }
        body { font-family: 'Segoe UI', sans-serif; background: #020617; color: white; text-align: center; margin: 0; padding: 10px; overflow: hidden; touch-action: manipulation; }
        
        /* –ü–∞–Ω–µ–ª—å –ø—Ä–æ–≥—Ä–µ—Å—Å–∞ –∏ –≤—ã–≤–æ–¥–∞ */
        .withdraw-panel { background: var(--accent-blue); border-radius: 15px; padding: 12px; margin-bottom: 10px; border: 1px solid rgba(255,255,255,0.2); }
        .progress-container { background: rgba(0,0,0,0.3); height: 10px; border-radius: 10px; margin-top: 8px; overflow: hidden; border: 1px solid #1e293b; }
        #progressBar { background: linear-gradient(90deg, #f59e0b, #fcd34d); width: 0%; height: 100%; transition: 0.5s; }

        /* –ö–∞—Ä—Ç–æ—á–∫–∞ –±–∞–ª–∞–Ω—Å–∞ */
        .wallet-card { background: #1e293b; border-radius: 20px; padding: 15px; margin-bottom: 10px; border: 1px solid #334155; display: flex; justify-content: space-around; box-shadow: 0 4px 15px rgba(0,0,0,0.5); }
        .balance-value { font-size: 24px; color: var(--main-yellow); font-weight: bold; text-shadow: 0 0 10px rgba(252, 211, 77, 0.5); }

        /* –ò–≥—Ä–æ–≤–∞—è —Å—Ü–µ–Ω–∞ */
        #game-scene { 
            position: relative; width: 100%; height: 260px; 
            background: linear-gradient(180deg, #38bdf8 0%, #0ea5e9 100%); 
            border-radius: 24px; overflow: hidden; margin-bottom: 10px; border: 3px solid #1e293b;
            box-shadow: inset 0 0 50px rgba(0,0,0,0.2);
        }

        #bird-container { position: absolute; left: 40px; top: 50%; transform: translateY(-50%); z-index: 15; transition: top 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275); }
        #bird { font-size: 55px; transform: scaleX(-1); display: inline-block; filter: drop-shadow(0 4px 4px rgba(0,0,0,0.3)); }
        
        #multiplier-badge { 
            position: absolute; top: 15px; left: 50%; transform: translateX(-50%); 
            background: rgba(0,0,0,0.7); padding: 4px 15px; border-radius: 20px; font-weight: bold; 
            display: none; border: 1px solid var(--main-yellow); color: var(--main-yellow);
        }

        .star-prize { position: absolute; right: -60px; font-size: 30px; z-index: 12; transition: right 0.7s linear; }
        .crash-symbol { font-size: 45px; z-index: 13; }

        /* –ö–Ω–æ–ø–∫–∏ —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è */
        .controls { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; }
        .btn { padding: 15px 5px; border: none; border-radius: 14px; font-weight: bold; cursor: pointer; color: white; font-size: 12px; transition: 0.2s; box-shadow: 0 4px 0 rgba(0,0,0,0.2); }
        .btn:active { transform: translateY(2px); box-shadow: none; }
        
        .btn-free { background: #8b5cf6; grid-column: span 2; font-size: 14px; }
        .btn-std { background: #10b981; }
        .btn-super { background: #f59e0b; }
        .btn-boost { background: #a855f7; grid-column: span 2; border: 2px solid white; animation: pulse 2s infinite; }
        
        .btn-take { background: var(--main-yellow); color: #000; grid-column: span 2; display: none; font-size: 24px; font-weight: 900; animation: pulse 1s infinite; }
        
        @keyframes pulse { 0% { transform: scale(1); } 50% { transform: scale(1.03); } 100% { transform: scale(1); } }

        /* –ò—Å—Ç–æ—Ä–∏—è */
        .history-panel { background: #0f172a; border-radius: 15px; padding: 12px; margin-top: 10px; max-height: 100px; overflow-y: auto; font-size: 13px; border: 1px solid #1e293b; }
        .hist-item { display: flex; justify-content: space-between; margin-bottom: 5px; border-bottom: 1px solid #1e293b; padding-bottom: 2px; }
        .win-text { color: #10b981; }
        .lose-text { color: var(--danger); }
    </style>
</head>
<body onclick="initAudio()">

    <div class="withdraw-panel">
        <div style="display: flex; justify-content: space-around; font-size: 11px; font-weight: bold;">
            <span>–ü–†–û–ì–†–ï–°–° –í–´–í–û–î–ê: <span id="with-val">0</span>%</span>
            <span>–î–†–£–ó–¨–Ø: <span id="ref-val">0</span>/5</span>
        </div>
        <div class="progress-container"><div id="progressBar"></div></div>
    </div>

    <div class="wallet-card">
        <div><small style="color: #94a3b8;">–í–ê–® –ë–ê–õ–ê–ù–°</small><div class="balance-value"><span id="balanceDisplay">0</span> ‚≠ê</div></div>
        <div><small style="color: #94a3b8;">–í –ü–û–õ–ï–¢–ï</small><div class="balance-value" style="color:white"><span id="currentWin">0</span> ‚≠ê</div></div>
    </div>

    <div id="game-scene">
        <div id="multiplier-badge">x1.00</div>
        <div id="bird-container">
            <div id="bird">üê¶‚Äç‚¨õ</div>
        </div>
    </div>

    <div class="controls" id="mainControls">
        <button id="freeBtn" class="btn btn-free" onclick="handleFlightAttempt(0)">–ë–ï–°–ü–õ–ê–¢–ù–´–ô –ü–û–õ–ï–¢ (–†–∞–∑ –≤ 8—á)</button>
        <button class="btn btn-std" onclick="handleFlightAttempt(50)">–û–ë–´–ß–ù–´–ô (50)</button>
        <button class="btn btn-super" onclick="handleFlightAttempt(150)">–°–£–ü–ï–† (150)</button>
        <button class="btn btn-boost" onclick="handleFlightAttempt(300)">üî• –ë–£–°–¢–ï–† (300) üî•</button>
        <button class="btn btn-free" style="background: #334155;" onclick="tg.showAlert('–ü—Ä–∏–≥–ª–∞—Å–∏ 5 –¥—Ä—É–∑–µ–π –¥–ª—è –≤—ã–≤–æ–¥–∞!')">–í–´–í–ï–°–¢–ò –°–†–ï–î–°–¢–í–ê</button>
    </div>
    
    <button id="takeBtn" class="btn btn-take" onclick="takeWin()">–ó–ê–ë–†–ê–¢–¨ ‚≠ê</button>

    <div class="history-panel" id="historyList">
        <div style="color: #64748b; margin-bottom: 5px;">–ò–°–¢–û–†–ò–Ø –ü–û–õ–ï–¢–û–í:</div>
    </div>

    <script>
        const tg = window.Telegram.WebApp;
        tg.expand();
        tg.enableClosingConfirmation();

        // --- –ù–ê–°–¢–†–û–ô–ö–ò –°–ï–†–í–ï–†–ê (–¢–í–û–ô NGROK) ---
        const NGROK_URL = "https://unnegotiated-adelina-contained.ngrok-free.dev"; 

        let balance = parseInt(localStorage.getItem('birdBalance')) || 100;
        let flightTotal = 0;
        let isPlaying = false;
        let flightInterval, multiInterval;
        let audioCtx = null;

        function initAudio() {
            if (!audioCtx) audioCtx = new (window.AudioContext || window.webkitAudioContext)();
        }

        function playSound(f, type, d) {
            if (!audioCtx) return;
            try {
                const o = audioCtx.createOscillator();
                const g = audioCtx.createGain();
                o.type = type; o.frequency.value = f;
                g.gain.setValueAtTime(0.1, audioCtx.currentTime);
                o.connect(g); g.connect(audioCtx.destination);
                o.start(); o.stop(audioCtx.currentTime + d);
            } catch(e) {}
        }

        function updateUI() {
            document.getElementById('balanceDisplay').innerText = balance;
            document.getElementById('currentWin').innerText = flightTotal;
            document.getElementById('takeBtn').innerText = `–ó–ê–ë–†–ê–¢–¨: ${flightTotal} ‚≠ê`;
            
            // –ü—Ä–æ–≥—Ä–µ—Å—Å –¥–æ 1000 –∑–≤–µ–∑–¥ –¥–ª—è –≤—ã–≤–æ–¥–∞
            let prog = Math.min((balance/1000)*100, 100);
            document.getElementById('progressBar').style.width = prog + '%';
            document.getElementById('with-val').innerText = Math.floor(prog);
            
            localStorage.setItem('birdBalance', balance);
            checkCooldown();
        }

        async function triggerExternalPayment(amount) {
            try {
                const res = await fetch(`${NGROK_URL}/pay`, {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({ 
                        user_id: tg.initDataUnsafe.user?.id, 
                        amount: amount 
                    })
                });
                const data = await res.json();
                if (data.link) {
                    tg.openInvoice(data.link, (status) => {
                        if (status === 'paid') {
                            balance += amount;
                            updateUI();
                            tg.showAlert(`–£—Å–ø–µ—à–Ω–æ! +${amount} ‚≠ê –Ω–∞ –±–∞–ª–∞–Ω—Å.`);
                        }
                    });
                }
            } catch (e) {
                tg.showAlert("–û—à–∏–±–∫–∞: –±–æ—Ç –Ω–∞ –∫–æ–º–ø—å—é—Ç–µ—Ä–µ –Ω–µ –æ—Ç–≤–µ—á–∞–µ—Ç. –ü—Ä–æ–≤–µ—Ä—å main.py –∏ ngrok!");
            }
        }

        function handleFlightAttempt(cost) {
            if (cost > balance && cost !== 0) {
                tg.showConfirm(`–£ –≤–∞—Å –º–∞–ª–æ –∑–≤–µ–∑–¥. –ü–æ–ø–æ–ª–Ω–∏—Ç—å –±–∞–ª–∞–Ω—Å –Ω–∞ ${cost} ‚≠ê?`, (ok) => {
                    if (ok) triggerExternalPayment(cost);
                });
                return;
            }
            if (cost === 0) {
                const last = localStorage.getItem('lastFree') || 0;
                if (Date.now() - last < 8*60*60*1000) return;
            }
            startFlight(cost);
        }

        function startFlight(cost) {
            isPlaying = true;
            balance -= cost;
            flightTotal = 0;
            if (cost === 0) localStorage.setItem('lastFree', Date.now());
            
            document.getElementById('mainControls').style.display = 'none';
            document.getElementById('takeBtn').style.display = 'block';
            document.getElementById('multiplier-badge').style.display = 'block';
            
            updateUI();
            let startTime = Date.now();

            // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –º–Ω–æ–∂–∏—Ç–µ–ª—è
            multiInterval = setInterval(() => {
                let sec = (Date.now() - startTime) / 1000;
                document.getElementById('multiplier-badge').innerText = 'x' + (1 + sec * 0.15).toFixed(2);
            }, 100);

            // –°–ø–∞–≤–Ω –æ–±—ä–µ–∫—Ç–æ–≤
            flightInterval = setInterval(() => {
                let sec = (Date.now() - startTime) / 1000;
                // –®–∞–Ω—Å –∫—Ä–∞—à–∞ —Ä–∞—Å—Ç–µ—Ç —Å–æ –≤—Ä–µ–º–µ–Ω–µ–º
                let crashChance = (sec * 7 + 5); 
                let isCrash = (Math.random() * 100) < crashChance;
                spawnObject(isCrash, cost, startTime);
            }, 850);
        }

        function spawnObject(isCrash, cost, startTime) {
            const obj = document.createElement('div');
            obj.className = 'star-prize' + (isCrash ? ' crash-symbol' : '');
            obj.innerHTML = isCrash ? "üí•" : "‚≠ê";
            obj.style.top = (Math.random() * 60 + 20) + '%';
            document.getElementById('game-scene').appendChild(obj);
            
            // –î–≤–∏–∂–µ–Ω–∏–µ
            setTimeout(() => obj.style.right = '75%', 50);

            // –°—Ç–æ–ª–∫–Ω–æ–≤–µ–Ω–∏–µ
            setTimeout(() => {
                if (!isPlaying) { obj.remove(); return; }
                
                // –ü—Ç–∏—Ü–∞ –ª–µ—Ç–∏—Ç –∫ –æ–±—ä–µ–∫—Ç—É
                document.getElementById('bird-container').style.top = obj.style.top;
                
                if (isCrash) {
                    endGame(false);
                } else {
                    let sec = (Date.now() - startTime) / 1000;
                    let reward = cost === 0 ? 3 : Math.floor(cost * 0.1 * (1 + sec * 0.2));
                    flightTotal += reward;
                    playSound(800 + (sec * 50), 'sine', 0.1);
                    updateUI();
                }
                obj.remove();
            }, 650);
        }

        function takeWin() {
            if (!isPlaying) return;
            balance += flightTotal;
            playSound(1200, 'sine', 0.4);
            endGame(true);
        }

        function endGame(isWin) {
            isPlaying = false;
            clearInterval(flightInterval);
            clearInterval(multiInterval);
            
            if (!isWin) {
                playSound(150, 'sawtooth', 0.5);
                tg.HapticFeedback.notificationOccurred('error');
            } else {
                tg.HapticFeedback.notificationOccurred('success');
            }
            
            // –ó–∞–ø–∏—Å—å –≤ –∏—Å—Ç–æ—Ä–∏—é
            const hist = document.getElementById('historyList');
            const item = document.createElement('div');
            item.className = 'hist-item';
            item.innerHTML = `<span>–ü–æ–ª–µ—Ç</span><span class="${isWin ? 'win-text' : 'lose-text'}">${isWin ? '+' : '-'}${isWin ? flightTotal : '–ö–†–ê–®'} ‚≠ê</span>`;
            hist.insertBefore(item, hist.childNodes[2]);
            
            // –°–±—Ä–æ—Å –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å–∞
            document.getElementById('mainControls').style.display = 'grid';
            document.getElementById('takeBtn').style.display = 'none';
            document.getElementById('multiplier-badge').style.display = 'none';
            document.getElementById('bird-container').style.top = '50%';
            
            flightTotal = 0;
            updateUI();
        }

        function checkCooldown() {
            const last = localStorage.getItem('lastFree') || 0;
            const diff = Date.now() - last;
            const btn = document.getElementById('freeBtn');
            const hours8 = 8*60*60*1000;
            
            if (diff < hours8) {
                btn.disabled = true;
                btn.style.opacity = 0.5;
                let left = Math.ceil((hours8 - diff) / (1000 * 60 * 60));
                btn.innerText = `–ñ–î–ò–¢–ï ${left} –ß.`;
            } else {
                btn.disabled = false;
                btn.style.opacity = 1;
                btn.innerText = "–ë–ï–°–ü–õ–ê–¢–ù–´–ô –ü–û–õ–ï–¢ (–†–∞–∑ –≤ 8—á)";
            }
        }

        // –ü–µ—Ä–≤—ã–π –∑–∞–ø—É—Å–∫
        updateUI();
    </script>
</body>
</html>
